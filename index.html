<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>American Football Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Tailwind gray-900 */
            color: #e2e8f0; /* Tailwind gray-200 */
        }
        .sidebar {
            width: 280px;
            background-color: #2d3748; /* Tailwind gray-800 */
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
        }
        .main-content {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .table-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .stat-bar {
            background-color: #4a5568; /* Tailwind gray-600 */
            height: 10px;
        }
        .stat-fill {
            background-color: #48bb78; /* Tailwind green-500 */
        }
        /* Style for scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        .text-neon-green {
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-bold transition-transform transform hover:scale-105;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>
<body class="flex min-h-screen">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 flex items-center justify-center bg-gray-900 z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-green-500"></div>
            <p class="mt-4 text-xl font-bold">Initializing Game...</p>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 z-40 hidden">
        <h1 class="text-6xl font-extrabold text-neon-green mb-10">AFM</h1>
        <div class="space-y-4">
            <button id="newGameBtn" class="btn bg-green-600 hover:bg-green-700 text-white w-64">New Game</button>
            <button id="loadGameBtn" class="btn bg-gray-700 hover:bg-gray-600 text-white w-64">Load Game</button>
            <div class="pt-4 border-t border-gray-700 w-64 space-y-2">
                <label for="urlInput" class="text-sm text-gray-400">Load from URL:</label>
                <input type="url" id="urlInput" placeholder="Enter .json URL" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 text-white placeholder-gray-500">
                <button id="loadUrlBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white w-full">Load from URL</button>
                <p id="urlError" class="text-sm text-red-400 hidden"></p>
            </div>
        </div>
    </div>

    <!-- Game Setup Screen -->
    <div id="setupScreen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 z-40 hidden">
        <h2 class="text-4xl font-extrabold text-neon-green mb-6">Game Setup</h2>
        <div class="bg-gray-800 rounded-lg p-8 shadow-xl max-w-xl w-full">
            <h3 class="text-xl font-bold mb-4">Choose Your League</h3>
            <div id="leagueSelection" class="space-y-4 mb-6">
                <!-- Leagues will be populated here -->
            </div>
            <button id="startGameBtn" class="btn bg-green-600 hover:bg-green-700 text-white w-full">Start Game</button>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer" class="flex flex-1 hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar flex flex-col p-4 shadow-lg z-10">
            <h1 class="text-3xl font-bold text-neon-green mb-6">AFM</h1>
            <nav class="space-y-4 flex-grow">
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="home">
                    Home
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="roster">
                    Roster
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="frontOffice">
                    Front Office
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="staffManagement">
                    Staff Management
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="standings">
                    Standings
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="schedule">
                    Schedule
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="history">
                    Historical Standings
                </button>
                <button id="draftBtn" class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors hidden" data-view="draft">
                    Draft
                </button>
            </nav>
            <div class="mt-auto pt-4 border-t border-gray-600">
                <button id="saveGameBtn" class="w-full text-left px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 transition-colors">
                    Save Game
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="mainContent" class="main-content flex flex-col items-start gap-6 relative">
            <div id="gameStatus" class="bg-gray-800 rounded-lg p-4 flex items-center justify-between w-full shadow-md">
                <div class="flex-1">
                    <span id="currentYear" class="text-lg font-bold"></span>
                    <p id="userTeam" class="text-sm text-gray-400"></p>
                    <p id="teamBudget" class="text-sm text-gray-400 mt-1"></p>
                </div>
                <button id="simulateBtn" class="btn bg-green-600 hover:bg-green-700">Simulate Week</button>
            </div>
            <div id="viewContainer" class="w-full">
                <!-- Dynamic content will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Player Modal -->
    <dialog id="playerModal" class="p-8 rounded-lg bg-gray-800 text-white shadow-xl max-w-2xl w-full z-20 modal-backdrop">
        <div class="flex justify-between items-start mb-4">
            <h3 id="modalTitle" class="text-2xl font-bold"></h3>
            <button id="closeModalBtn" class="text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="modalContent" class="space-y-4">
            <!-- Player details will be inserted here -->
        </div>
    </dialog>

    <!-- Staff Modal -->
    <dialog id="staffModal" class="p-8 rounded-lg bg-gray-800 text-white shadow-xl max-w-2xl w-full z-20 modal-backdrop">
        <div class="flex justify-between items-start mb-4">
            <h3 id="staffModalTitle" class="text-2xl font-bold"></h3>
            <button id="closeStaffModalBtn" class="text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="staffModalContent" class="space-y-4">
            <!-- Staff details will be inserted here -->
        </div>
    </dialog>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, getDocs, updateDoc, deleteDoc, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        let db;
        let userId;

        // Game State Variables
        const state = {
            view: 'home',
            gameState: 'regularSeason', // 'regularSeason', 'offseason'
            currentYear: 2025,
            weeksSimulated: 0,
            userTeamId: 'user_team',
            teamBudget: 5000000,
            
            // In-memory data
            players: [],
            highSchoolPlayers: [],
            collegePlayers: [],
            teams: [],
            staff: [],
            availableStaff: [],
            draftPool: [],
            historicalSeasons: [],
            
            draftRound: 1,
            draftPick: 1,
            leagues: {
                pro: { name: 'Pro League', teams: 32 },
                college: { name: 'College League', teams: 128 },
                highschool: { name: 'High School League', teams: 256 }
            }
        };

        const positions = ['QB', 'RB', 'WR', 'TE', 'OL', 'DL', 'LB', 'DB'];
        const teamNames = [
            'Falcons', 'Bills', 'Panthers', 'Bears', 'Bengals', 'Browns', 'Cowboys', 'Broncos',
            'Lions', 'Packers', 'Texans', 'Colts', 'Jaguars', 'Chiefs', 'Raiders', 'Chargers',
            'Rams', 'Dolphins', 'Vikings', 'Patriots', 'Saints', 'Giants', 'Jets', 'Eagles',
            'Steelers', '49ers', 'Seahawks', 'Buccaneers', 'Titans', 'Commanders', 'Ravens', 'Cardinals'
        ];
        const staffRoles = ['Head Coach', 'Offensive Coordinator', 'Defensive Coordinator', 'QB Coach', 'RB Coach', 'WR Coach', 'TE Coach', 'OL Coach', 'DL Coach', 'DB Coach'];

        // --- Firebase Initialization ---
        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('startScreen').classList.remove('hidden');
                } else {
                    console.error("Firebase config is missing. Cannot initialize Firestore.");
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('startScreen').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('loadingScreen').classList.add('hidden');
            }
        };

        const handleAuthentication = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User signed in with ID:", userId);
                    } else {
                        console.log("No user is signed in.");
                        userId = null;
                    }
                });
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        };

        // --- Data Models and Generators ---
        class Player {
            constructor(name, position, age, potential, teamId, league) {
                this.name = name;
                this.position = position;
                this.age = age;
                this.potential = potential;
                this.teamId = teamId;
                this.league = league;
                this.attributes = this.generateAttributes(league);
                this.salary = Math.floor(Math.random() * 1000000) + 500000;
                this.stats = {
                    games: 0, tackles: 0, sacks: 0, interceptions: 0, passingYards: 0,
                    passingTDs: 0, rushingYards: 0, rushingTDs: 0, receivingYards: 0, receivingTDs: 0
                };
            }

            generateAttributes(league) {
                const baseRating = league === 'highschool' ? 20 : (league === 'college' ? 40 : 60);
                const randomRange = league === 'highschool' ? 40 : (league === 'college' ? 30 : 20);
            
                const generateStat = () => Math.floor(Math.random() * randomRange) + baseRating;
            
                const attributes = {
                    physical: {
                        strength: generateStat(), speed: generateStat(), endurance: generateStat(), agility: generateStat()
                    },
                    mental: {
                        awareness: generateStat(), leadership: generateStat(), determination: generateStat(), tenacity: generateStat()
                    },
                    technical: {}
                };
            
                switch(this.position) {
                    case 'QB':
                        attributes.technical.accuracy = generateStat();
                        attributes.technical.arm_strength = generateStat();
                        attributes.technical.play_action = generateStat();
                        break;
                    case 'RB':
                        attributes.technical.elusiveness = generateStat();
                        attributes.technical.breaking_tackles = generateStat();
                        attributes.technical.vision = generateStat();
                        break;
                    case 'WR':
                        attributes.technical.route_running = generateStat();
                        attributes.technical.catching = generateStat();
                        attributes.technical.jumping = generateStat();
                        break;
                    case 'TE':
                        attributes.technical.blocking = generateStat();
                        attributes.technical.catching = generateStat();
                        attributes.technical.route_running = generateStat();
                        break;
                    case 'OL':
                        attributes.technical.pass_block = generateStat();
                        attributes.technical.run_block = generateStat();
                        break;
                    case 'DL':
                        attributes.technical.pass_rush_moves = generateStat();
                        attributes.technical.tackling = generateStat();
                        break;
                    case 'LB':
                        attributes.technical.tackling = generateStat();
                        attributes.technical.coverage = generateStat();
                        attributes.technical.block_shedding = generateStat();
                        break;
                    case 'DB':
                        attributes.technical.man_coverage = generateStat();
                        attributes.technical.zone_coverage = generateStat();
                        attributes.technical.tackling = generateStat();
                        break;
                }
            
                return attributes;
            }

            getOverallRating() {
                const physicalTotal = Object.values(this.attributes.physical).reduce((sum, val) => sum + val, 0);
                const mentalTotal = Object.values(this.attributes.mental).reduce((sum, val) => sum + val, 0);
                const technicalTotal = Object.values(this.attributes.technical).reduce((sum, val) => sum + val, 0);
            
                let overall = 0;
            
                switch(this.position) {
                    case 'QB':
                        overall = (physicalTotal * 0.2) + (mentalTotal * 0.3) + (technicalTotal * 0.5);
                        break;
                    case 'RB':
                        overall = (physicalTotal * 0.4) + (mentalTotal * 0.2) + (technicalTotal * 0.4);
                        break;
                    case 'WR':
                        overall = (physicalTotal * 0.3) + (mentalTotal * 0.2) + (technicalTotal * 0.5);
                        break;
                    case 'TE':
                        overall = (physicalTotal * 0.3) + (mentalTotal * 0.2) + (technicalTotal * 0.5);
                        break;
                    case 'OL':
                        overall = (physicalTotal * 0.5) + (mentalTotal * 0.3) + (technicalTotal * 0.2);
                        break;
                    case 'DL':
                        overall = (physicalTotal * 0.4) + (mentalTotal * 0.2) + (technicalTotal * 0.4);
                        break;
                    case 'LB':
                        overall = (physicalTotal * 0.3) + (mentalTotal * 0.3) + (technicalTotal * 0.4);
                        break;
                    case 'DB':
                        overall = (physicalTotal * 0.3) + (mentalTotal * 0.2) + (technicalTotal * 0.5);
                        break;
                    default:
                        overall = (physicalTotal + mentalTotal + technicalTotal) / 10;
                        break;
                }
            
                return Math.floor(overall);
            }
        }

        class Staff {
            constructor(name, role, teamId) {
                this.name = name;
                this.role = role;
                this.teamId = teamId;
                this.skills = this.generateSkills();
                this.salary = Math.floor(Math.random() * 500000) + 100000;
            }

            generateSkills() {
                const skills = {};
                if (this.role === 'Head Coach') {
                    skills.management = Math.floor(Math.random() * 50) + 50;
                    skills.leadership = Math.floor(Math.random() * 50) + 50;
                } else if (this.role.includes('Coordinator')) {
                    skills.scheme = Math.floor(Math.random() * 50) + 50;
                } else {
                    skills.development = Math.floor(Math.random() * 50) + 50;
                }
                return skills;
            }
        }

        const generateTeams = (numTeams, leagueName) => {
            const teams = [];
            const shuffledNames = teamNames.sort(() => 0.5 - Math.random());
            for (let i = 0; i < numTeams; i++) {
                teams.push({
                    id: `${leagueName}_team_${i}`,
                    name: shuffledNames[i] || `${leagueName} Team ${i}`,
                    wins: 0,
                    losses: 0,
                    ties: 0
                });
            }
            return teams;
        };
        
        const generatePlayers = (numPlayers, ageRange, league) => {
            const players = [];
            for (let i = 0; i < numPlayers; i++) {
                const name = `Player ${i}`;
                const position = positions[Math.floor(Math.random() * positions.length)];
                const potential = Math.floor(Math.random() * 100) + 1;
                const age = Math.floor(Math.random() * (ageRange[1] - ageRange[0] + 1)) + ageRange[0];
                players.push(new Player(name, position, age, potential, null, league));
            }
            return players;
        };

        const generateStaff = (numStaff) => {
            const staff = [];
            const shuffledRoles = staffRoles.sort(() => 0.5 - Math.random());
            for (let i = 0; i < numStaff; i++) {
                const role = shuffledRoles[i % shuffledRoles.length];
                staff.push(new Staff(`Staff ${i}`, role, null));
            }
            return staff;
        };
        
        const generateDraftPool = () => {
            const draftEligiblePlayers = state.collegePlayers.filter(p => p.age >= 21 || p.getOverallRating() > 85);
            state.draftPool = draftEligiblePlayers.sort((a, b) => b.potential - a.potential).slice(0, 200);
        };

        // --- Game Simulation and Logic ---
        const simulateGame = (team1, team2) => {
            const getTeamRating = (teamId) => {
                const teamPlayers = state.players.filter(p => p.teamId === teamId);
                if (teamPlayers.length === 0) return 0;
                return teamPlayers.reduce((sum, p) => sum + p.getOverallRating(), 0) / teamPlayers.length;
            };

            const team1Doc = state.teams.find(t => t.id === team1);
            const team2Doc = state.teams.find(t => t.id === team2);
            if (!team1Doc || !team2Doc) return;

            const rating1 = getTeamRating(team1);
            const rating2 = getTeamRating(team2);
            const ratingDifference = rating1 - rating2;

            const baseScore1 = Math.floor(Math.random() * 30) + 10;
            const baseScore2 = Math.floor(Math.random() * 30) + 10;

            const score1 = Math.max(0, baseScore1 + Math.round(ratingDifference / 5));
            const score2 = Math.max(0, baseScore2 - Math.round(ratingDifference / 5));

            if (score1 > score2) {
                team1Doc.wins++;
                team2Doc.losses++;
            } else if (score2 > score1) {
                team2Doc.wins++;
                team1Doc.losses++;
            } else {
                team1Doc.ties++;
                team2Doc.ties++;
            }
        };

        const simulateSeason = async () => {
            // Pay salaries
            const playerSalaryTotal = state.players.filter(p => p.teamId === state.userTeamId).reduce((sum, p) => sum + p.salary, 0);
            const staffSalaryTotal = state.staff.filter(s => s.teamId === state.userTeamId).reduce((sum, s) => sum + s.salary, 0);
            state.teamBudget -= playerSalaryTotal + staffSalaryTotal;

            // Simulate games
            for (let i = 0; i < state.teams.length; i++) {
                for (let j = i + 1; j < state.teams.length; j++) {
                    simulateGame(state.teams[i].id, state.teams[j].id);
                }
            }
            await saveTeams();
        };

        const progressPlayers = async () => {
            const batch = writeBatch(db);
            
            // Progress Pro, College, and High School players
            const allPlayers = [...state.players, ...state.collegePlayers, ...state.highSchoolPlayers];
            allPlayers.forEach(p => {
                p.age++;
                if (p.age < 28) {
                    const improvement = Math.random() * (p.potential / 100) * (p.league === 'highschool' ? 20 : (p.league === 'college' ? 15 : 10));
                    for (const category in p.attributes) {
                        for (const attr in p.attributes[category]) {
                            p.attributes[category][attr] = Math.min(100, p.attributes[category][attr] + improvement);
                        }
                    }
                }
                const playerRef = doc(db, playersPath(), p.id);
                batch.update(playerRef, { attributes: p.attributes, age: p.age });
            });
            await batch.commit();
        };

        const enterOffseason = async () => {
            state.gameState = 'offseason';
            state.weeksSimulated = 0;
            await saveGameState();

            await progressPlayers();
            await recordSeasonHistory();
            await handlePlayerAgingAndRetirement();
            await handleCollegeRecruitment();
            generateDraftPool();
            await saveDraftPool();
            
            state.view = 'draft';
            renderUI();
        };

        const recordSeasonHistory = async () => {
            const seasonStats = {
                year: state.currentYear,
                standings: state.teams.sort((a, b) => (b.wins - b.losses) - (a.wins - a.losses)).map(t => ({
                    id: t.id,
                    name: t.name,
                    wins: t.wins,
                    losses: t.losses,
                    ties: t.ties
                }))
            };
            await addDoc(collection(db, historyPath()), seasonStats);
        };

        const handlePlayerAgingAndRetirement = async () => {
            const batch = writeBatch(db);
            state.players = state.players.filter(p => {
                const retireChance = p.age > 35 ? (p.age - 35) * 0.15 : 0;
                if (Math.random() < retireChance) {
                    batch.delete(doc(db, playersPath(), p.id));
                    return false;
                }
                return true;
            });
            await batch.commit();
            await savePlayers();
        };

        const handleCollegeRecruitment = async () => {
            const newHighSchoolPlayers = generatePlayers(state.leagues.highschool.teams * 25, [17, 18], 'highschool');
            const newCollegePlayers = state.highSchoolPlayers.filter(p => p.age >= 18);

            const batch = writeBatch(db);
            // Move players to college
            newCollegePlayers.forEach(p => {
                const playerRef = doc(db, playersPath(), p.id);
                batch.update(playerRef, { league: 'college' });
            });
            // Add new high school players
            newHighSchoolPlayers.forEach(p => {
                batch.add(collection(db, playersPath()), { ...p });
            });
            await batch.commit();
        };
        
        const simulateDraftPick = async () => {
            if (state.draftPool.length === 0) {
                alert("The draft is over! Starting next season.");
                await startNextSeason();
                return;
            }
            
            const numTeams = state.teams.length;
            const teamsInDraftOrder = [...state.teams].sort((a, b) => a.wins - b.wins);

            while (state.draftPick <= numTeams && state.draftPool.length > 0) {
                const currentTeam = teamsInDraftOrder[state.draftPick - 1];
                if (currentTeam.id === state.userTeamId) {
                    return;
                }

                const pickedPlayer = state.draftPool.shift();
                pickedPlayer.teamId = currentTeam.id;
                pickedPlayer.league = 'pro';
                await updateDoc(doc(db, playersPath(), pickedPlayer.id), { teamId: pickedPlayer.teamId, league: 'pro' });
                await saveDraftPool();
                state.draftPick++;
                renderUI();
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (state.draftPick > numTeams) {
                state.draftRound++;
                state.draftPick = 1;
                if (state.draftRound > 7) {
                    alert("The draft is over! Starting next season.");
                    await startNextSeason();
                    return;
                }
            }
            await saveGameState();
            renderUI();
        };

        const startNextSeason = async () => {
            state.currentYear++;
            state.gameState = 'regularSeason';
            state.weeksSimulated = 0;
            // Reset team stats
            state.teams.forEach(t => {
                t.wins = 0;
                t.losses = 0;
                t.ties = 0;
            });
            await saveGameState();
            await saveTeams();
            state.view = 'home';
            renderUI();
        };

        const draftPlayer = async (playerId) => {
            const playerIndex = state.draftPool.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                alert("This player is no longer available.");
                return;
            }
        
            const draftedPlayer = state.draftPool.splice(playerIndex, 1)[0];
            await updateDoc(doc(db, playersPath(), draftedPlayer.id), { teamId: state.userTeamId, league: 'pro' });
            state.draftPick++;
        
            await saveDraftPool();
            await saveGameState();
            await simulateDraftPick();
        };

        // --- UI Rendering ---
        const renderUI = () => {
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = '';
            document.getElementById('currentYear').textContent = `Year: ${state.currentYear}`;
            document.getElementById('userTeam').textContent = `Team: ${state.teams.find(t => t.id === state.userTeamId)?.name || 'Unknown'}`;
            document.getElementById('teamBudget').textContent = `Budget: $${state.teamBudget.toLocaleString('en-US')}`;

            const simulateBtn = document.getElementById('simulateBtn');
            const draftBtn = document.getElementById('draftBtn');
            draftBtn.classList.add('hidden');

            if (state.gameState === 'offseason') {
                simulateBtn.textContent = 'Simulate Draft Pick';
                simulateBtn.disabled = false;
                draftBtn.classList.remove('hidden');
            } else {
                simulateBtn.textContent = state.weeksSimulated < 16 ? `Simulate Week ${state.weeksSimulated + 1}` : 'End Season & Enter Offseason';
                simulateBtn.disabled = false;
            }
            
            switch (state.view) {
                case 'home': renderHome(); break;
                case 'roster': renderRoster(); break;
                case 'frontOffice': renderFrontOffice(); break;
                case 'staffManagement': renderStaffManagement(); break;
                case 'standings': renderStandings(); break;
                case 'schedule': renderSchedule(); break;
                case 'history': renderHistoricalStandings(); break;
                case 'draft':
                    if (state.gameState === 'offseason') {
                        renderDraft();
                    } else {
                        renderDraftPlaceholder();
                    }
                    break;
            }
        };

        const renderHome = () => {
            const container = document.getElementById('viewContainer');
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Welcome to American Football Manager</h2>
                    <p class="text-gray-400">Manage your team from the ground up, scouting players from high school and college to build a dynasty in the pro league. Simulate seasons and guide your team to victory!</p>
                </div>
            `;
        };

        const renderRoster = () => {
            const container = document.getElementById('viewContainer');
            const userRoster = state.players.filter(p => p.teamId === state.userTeamId);

            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Team Roster</h2>
                    <div class="table-container">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-700">
                                    <th class="p-4 rounded-tl-lg">Name</th>
                                    <th class="p-4">POS</th>
                                    <th class="p-4">Age</th>
                                    <th class="p-4">OVR</th>
                                    <th class="p-4">Potential</th>
                                    <th class="p-4 rounded-tr-lg">Salary</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userRoster.map(p => `
                                    <tr class="border-t border-gray-700 hover:bg-gray-700 cursor-pointer player-row" data-id="${p.id}">
                                        <td class="p-4">${p.name}</td>
                                        <td class="p-4">${p.position}</td>
                                        <td class="p-4">${p.age}</td>
                                        <td class="p-4">${p.getOverallRating()}</td>
                                        <td class="p-4">${p.potential}</td>
                                        <td class="p-4">$${p.salary.toLocaleString('en-US')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            container.querySelectorAll('.player-row').forEach(row => {
                row.addEventListener('click', (e) => showPlayerModal(e.currentTarget.dataset.id));
            });
        };
        
        const renderFrontOffice = () => {
            const container = document.getElementById('viewContainer');
            const userStaff = state.staff.filter(s => s.teamId === state.userTeamId);
            const headCoach = userStaff.find(s => s.role === 'Head Coach');
            const offensiveCoordinator = userStaff.find(s => s.role === 'Offensive Coordinator');
            const defensiveCoordinator = userStaff.find(s => s.role === 'Defensive Coordinator');
            const positionalCoaches = userStaff.filter(s => s.role.includes('Coach') && s.role !== 'Head Coach');

            const renderStaffCard = (staff) => {
                if (!staff) return '<div class="bg-gray-700 rounded-lg p-4 shadow-md text-center text-gray-400">No staff hired</div>';
                let skillsHtml = Object.entries(staff.skills).map(([skill, value]) => `
                    <div class="flex items-center space-x-2">
                        <span class="capitalize text-sm font-semibold">${skill}:</span>
                        <div class="bg-gray-600 rounded-full h-2 flex-1">
                            <div class="bg-green-500 rounded-full h-2" style="width: ${value}%"></div>
                        </div>
                        <span class="text-xs text-gray-400">${value}</span>
                    </div>
                `).join('');

                return `
                    <div class="bg-gray-700 rounded-lg p-4 shadow-md">
                        <h3 class="font-bold text-lg">${staff.name}</h3>
                        <p class="text-gray-400 text-sm mb-2">${staff.role}</p>
                        <p class="text-gray-300 text-sm mb-2">Salary: $${staff.salary.toLocaleString('en-US')}</p>
                        <div class="space-y-1 mt-2">
                            ${skillsHtml}
                        </div>
                    </div>
                `;
            };

            const positionalCoachesHtml = positionalCoaches.map(coach => renderStaffCard(coach)).join('');

            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Front Office</h2>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-xl font-bold mb-2">Head Coach</h3>
                            ${renderStaffCard(headCoach)}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">Coordinators</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${renderStaffCard(offensiveCoordinator)}
                                ${renderStaffCard(defensiveCoordinator)}
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">Positional Coaches</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${positionalCoachesHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderStaffManagement = () => {
            const container = document.getElementById('viewContainer');
            const userStaff = state.staff.filter(s => s.teamId === state.userTeamId);
            const availableStaff = state.availableStaff;
        
            const renderStaffTable = (staffList, actionBtnText, actionFn) => {
                return `
                    <div class="table-container bg-gray-700 rounded-lg p-4 shadow-md">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-600">
                                    <th class="p-4 rounded-tl-lg">Name</th>
                                    <th class="p-4">Role</th>
                                    <th class="p-4">Salary</th>
                                    <th class="p-4 rounded-tr-lg">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${staffList.map(s => `
                                    <tr class="border-t border-gray-500 hover:bg-gray-600 cursor-pointer staff-row" data-id="${s.id}">
                                        <td class="p-4">${s.name}</td>
                                        <td class="p-4">${s.role}</td>
                                        <td class="p-4">$${s.salary.toLocaleString('en-US')}</td>
                                        <td class="p-4">
                                            <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-lg text-xs staff-action-btn" data-id="${s.id}" data-action="${actionFn}">${actionBtnText}</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };
        
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Staff Management</h2>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-2">Your Staff</h3>
                        ${renderStaffTable(userStaff, 'Fire', 'fire')}
                    </div>
        
                    <div>
                        <h3 class="text-xl font-bold mb-2">Available Staff</h3>
                        ${renderStaffTable(availableStaff, 'Hire', 'hire')}
                    </div>
                </div>
            `;

            container.querySelectorAll('.staff-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('staff-action-btn')) {
                        showStaffModal(e.currentTarget.dataset.id);
                    }
                });
            });

            container.querySelectorAll('.staff-action-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const staffId = e.target.dataset.id;
                    const action = e.target.dataset.action;
                    if (action === 'hire') {
                        await hireStaff(staffId);
                    } else if (action === 'fire') {
                        await fireStaff(staffId);
                    }
                });
            });
        };
        
        const hireStaff = async (staffId) => {
            const staff = state.availableStaff.find(s => s.id === staffId);
            if (!staff) return;
        
            if (state.teamBudget < staff.salary) {
                alert("Not enough budget to hire this staff member!");
                return;
            }
        
            const currentStaff = state.staff.filter(s => s.teamId === state.userTeamId);
            if (staff.role === 'Head Coach' && currentStaff.find(s => s.role === 'Head Coach')) {
                alert('You already have a Head Coach.');
                return;
            }
            if (staff.role === 'Offensive Coordinator' && currentStaff.find(s => s.role === 'Offensive Coordinator')) {
                alert('You already have an Offensive Coordinator.');
                return;
            }
            if (staff.role === 'Defensive Coordinator' && currentStaff.find(s => s.role === 'Defensive Coordinator')) {
                alert('You already have a Defensive Coordinator.');
                return;
            }
            if (staff.role.includes('Coach') && currentStaff.filter(s => s.role === staff.role).length >= 1) {
                alert(`You already have a ${staff.role}.`);
                return;
            }
            
            await updateDoc(doc(db, availableStaffPath(), staff.id), { teamId: state.userTeamId });
            state.teamBudget -= staff.salary;
            await saveGameState();
            renderUI();
        };

        const fireStaff = async (staffId) => {
            const staff = state.staff.find(s => s.id === staffId);
            if (!staff) return;

            await updateDoc(doc(db, staffPath(), staff.id), { teamId: null });
            state.teamBudget += staff.salary / 2;
        
            await saveGameState();
            renderUI();
        };

        const renderStandings = () => {
            const container = document.getElementById('viewContainer');
            const standings = [...state.teams].sort((a, b) => (b.wins - b.losses) - (a.wins - a.losses));

            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Current Standings</h2>
                    <div class="table-container">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-700">
                                    <th class="p-4 rounded-tl-lg">Team</th>
                                    <th class="p-4">Wins</th>
                                    <th class="p-4">Losses</th>
                                    <th class="p-4 rounded-tr-lg">Ties</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${standings.map(t => `
                                    <tr class="border-t border-gray-700">
                                        <td class="p-4">${t.name}</td>
                                        <td class="p-4">${t.wins}</td>
                                        <td class="p-4">${t.losses}</td>
                                        <td class="p-4">${t.ties}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const renderHistoricalStandings = () => {
            const container = document.getElementById('viewContainer');
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Historical Standings</h2>
                    ${state.historicalSeasons.map(season => `
                        <div class="bg-gray-700 rounded-lg p-4 mb-4 shadow-md">
                            <h3 class="text-xl font-bold mb-2">Year: ${season.year}</h3>
                            <div class="table-container">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-gray-600">
                                            <th class="p-2">Team</th>
                                            <th class="p-2">Wins</th>
                                            <th class="p-2">Losses</th>
                                            <th class="p-2">Ties</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${season.standings.map(t => `
                                            <tr class="border-t border-gray-500">
                                                <td class="p-2">${t.name}</td>
                                                <td class="p-2">${t.wins}</td>
                                                <td class="p-2">${t.losses}</td>
                                                <td class="p-2">${t.ties}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        };

        const renderSchedule = () => {
            const container = document.getElementById('viewContainer');
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Season Schedule</h2>
                    <p class="text-gray-400">The schedule is currently being generated...</p>
                </div>
            `;
        };

        const renderDraft = () => {
            const container = document.getElementById('viewContainer');
            const userTeam = state.teams.find(t => t.id === state.userTeamId);
            
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Pro Draft</h2>
                    <p class="text-gray-400 mb-2">Round: ${state.draftRound} | Pick: ${state.draftPick}</p>
                    <p class="text-gray-400 mb-4">Select a player from the draft pool to add to your team.</p>
                    <div class="table-container">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-700">
                                    <th class="p-4 rounded-tl-lg">Name</th>
                                    <th class="p-4">POS</th>
                                    <th class="p-4">Age</th>
                                    <th class="p-4">OVR</th>
                                    <th class="p-4">Potential</th>
                                    <th class="p-4 rounded-tr-lg">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.draftPool.map(p => `
                                    <tr class="border-t border-gray-700 hover:bg-gray-700 cursor-pointer player-row" data-id="${p.id}">
                                        <td class="p-4">${p.name}</td>
                                        <td class="p-4">${p.position}</td>
                                        <td class="p-4">${p.age}</td>
                                        <td class="p-4">${p.getOverallRating()}</td>
                                        <td class="p-4">${p.potential}</td>
                                        <td class="p-4">
                                            <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm draft-btn" data-id="${p.id}">Draft</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            container.querySelectorAll('.player-row').forEach(row => {
                row.addEventListener('click', (e) => showPlayerModal(e.currentTarget.dataset.id));
            });
            container.querySelectorAll('.draft-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const playerId = e.currentTarget.dataset.id;
                    await draftPlayer(playerId);
                });
            });
            document.getElementById('simulateBtn').disabled = false;
        };
        
        const renderDraftPlaceholder = () => {
             const container = document.getElementById('viewContainer');
             container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Pro Draft Pool</h2>
                    <p class="text-gray-400">The draft pool will be populated by college players who have declared after their senior year. Please enter the offseason to view the draft pool.</p>
                </div>
            `;
        }


        const showPlayerModal = (playerId) => {
            const player = [...state.players, ...state.collegePlayers, ...state.highSchoolPlayers, ...state.draftPool].find(p => p.id === playerId);
            if (!player) return;

            const modal = document.getElementById('playerModal');
            document.getElementById('modalTitle').textContent = `${player.name} (${player.position})`;
            const modalContent = document.getElementById('modalContent');
            
            let attributesHtml = '';
            for (const category in player.attributes) {
                attributesHtml += `<h4 class="font-bold text-lg capitalize">${category.replace('_', ' ')} Attributes</h4>`;
                attributesHtml += `<div class="space-y-2 mt-2 mb-4">`;
                for (const attr in player.attributes[category]) {
                    const value = player.attributes[category][attr];
                    attributesHtml += `
                        <div>
                            <span class="capitalize">${attr.replace('_', ' ')}:</span>
                            <div class="bg-gray-600 rounded-full h-2.5">
                                <div class="bg-green-500 rounded-full h-2.5" style="width: ${value}%"></div>
                            </div>
                        </div>
                    `;
                }
                attributesHtml += `</div>`;
            }

            modalContent.innerHTML = `
                <p><strong>Age:</strong> ${player.age}</p>
                <p><strong>Overall:</strong> ${player.getOverallRating()}</p>
                <p><strong>League:</strong> ${player.league}</p>
                <p><strong>Team:</strong> ${state.teams.find(t => t.id === player.teamId)?.name || 'N/A'}</p>
                <p><strong>Salary:</strong> $${player.salary.toLocaleString('en-US')}</p>
                <div class="mt-4">
                    ${attributesHtml}
                </div>
            `;
            modal.showModal();
        };

        const showStaffModal = (staffId) => {
            const staff = [...state.staff, ...state.availableStaff].find(s => s.id === staffId);
            if (!staff) return;

            const modal = document.getElementById('staffModal');
            document.getElementById('staffModalTitle').textContent = `${staff.name} (${staff.role})`;
            const modalContent = document.getElementById('staffModalContent');

            let skillsHtml = '';
            for (const skill in staff.skills) {
                const value = staff.skills[skill];
                skillsHtml += `
                    <div>
                        <span class="capitalize">${skill}:</span>
                        <div class="bg-gray-600 rounded-full h-2.5">
                            <div class="bg-green-500 rounded-full h-2.5" style="width: ${value}%"></div>
                        </div>
                    </div>
                `;
            }

            modalContent.innerHTML = `
                <p><strong>Role:</strong> ${staff.role}</p>
                <p><strong>Salary:</strong> $${staff.salary.toLocaleString('en-US')}</p>
                <div class="space-y-2 mt-4">
                    <h4 class="font-bold text-lg">Skills</h4>
                    ${skillsHtml}
                </div>
            `;
            modal.showModal();
        };

        // --- Firebase Data Operations ---
        const gameDataPath = () => `artifacts/${appId}/users/${userId}/gameData/state`;
        const teamsPath = () => `artifacts/${appId}/users/${userId}/teams`;
        const playersPath = () => `artifacts/${appId}/users/${userId}/players`;
        const staffPath = () => `artifacts/${appId}/users/${userId}/staff`;
        const availableStaffPath = () => `artifacts/${appId}/users/${userId}/availableStaff`;
        const draftPoolPath = () => `artifacts/${appId}/users/${userId}/draftPool`;
        const historyPath = () => `artifacts/${appId}/users/${userId}/historicalSeasons`;
        
        const saveGameState = async () => {
            if (!db || !userId) return;
            try {
                await setDoc(doc(db, gameDataPath()), {
                    currentYear: state.currentYear,
                    weeksSimulated: state.weeksSimulated,
                    userTeamId: state.userTeamId,
                    teamBudget: state.teamBudget,
                    gameState: state.gameState,
                    draftRound: state.draftRound,
                    draftPick: state.draftPick,
                });
                console.log("Game state saved.");
            } catch (error) {
                console.error("Failed to save game state:", error);
            }
        };

        const saveTeams = async () => {
            if (!db || !userId) return;
            const batch = writeBatch(db);
            state.teams.forEach(t => {
                const teamRef = doc(db, teamsPath(), t.id);
                batch.set(teamRef, t);
            });
            await batch.commit();
        };

        const savePlayers = async (playersToSave) => {
            if (!db || !userId) return;
            const batch = writeBatch(db);
            playersToSave.forEach(p => {
                const playerRef = doc(db, playersPath(), p.id);
                batch.set(playerRef, p);
            });
            await batch.commit();
        };

        const saveStaff = async (staffToSave, collectionPath) => {
            if (!db || !userId) return;
            const batch = writeBatch(db);
            staffToSave.forEach(s => {
                const staffRef = doc(db, collectionPath, s.id);
                batch.set(staffRef, s);
            });
            await batch.commit();
        };

        const saveDraftPool = async () => {
            if (!db || !userId) return;
            const batch = writeBatch(db);
            const docs = await getDocs(collection(db, draftPoolPath()));
            docs.forEach(d => batch.delete(d.ref));
            state.draftPool.forEach(p => {
                const playerRef = doc(db, draftPoolPath(), p.id);
                batch.set(playerRef, p);
            });
            await batch.commit();
        };

        const loadGameState = async () => {
            if (!db || !userId) {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('startScreen').classList.remove('hidden');
                return;
            }
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');

            const stateRef = doc(db, gameDataPath());
            
            try {
                const stateDoc = await getDoc(stateRef);
                if (!stateDoc.exists()) {
                    console.log("No game state found, showing setup screen.");
                    showSetupScreen();
                    return;
                }

                const data = stateDoc.data();
                Object.assign(state, data);
                console.log("Game state loaded.");

                onSnapshot(collection(db, teamsPath()), (querySnapshot) => {
                    state.teams = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUI();
                });
                onSnapshot(query(collection(db, playersPath()), where('league', '==', 'pro')), (querySnapshot) => {
                    state.players = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUI();
                });
                onSnapshot(query(collection(db, playersPath()), where('league', '==', 'highschool')), (querySnapshot) => {
                    state.highSchoolPlayers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUI();
                });
                onSnapshot(query(collection(db, playersPath()), where('league', '==', 'college')), (querySnapshot) => {
                    state.collegePlayers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUI();
                });
                onSnapshot(query(collection(db, staffPath()), where('teamId', '!=', null)), (querySnapshot) => {
                    state.staff = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUI();
                });
                onSnapshot(query(collection(db, staffPath()), where('teamId', '==', null)), (querySnapshot) => {
                    state.availableStaff = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUI();
                });
                onSnapshot(collection(db, draftPoolPath()), (querySnapshot) => {
                    state.draftPool = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUI();
                });
                onSnapshot(collection(db, historyPath()), (querySnapshot) => {
                    state.historicalSeasons = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUI();
                });

            } catch (error) {
                console.error("Failed to load game state:", error);
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('gameContainer').classList.remove('hidden');
            }
        };

        const loadFromUrl = async () => {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            const urlError = document.getElementById('urlError');

            if (!url) {
                urlError.textContent = "Please enter a valid URL.";
                urlError.classList.remove('hidden');
                return;
            } else {
                urlError.classList.add('hidden');
            }

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const gameData = await response.json();

                if (!gameData.state || !gameData.players || !gameData.teams || !gameData.staff) {
                    throw new Error("Invalid game data format. Missing required fields.");
                }
                
                Object.assign(state, gameData.state);
                await saveGameState();

                const playersWithId = gameData.players.map(p => ({ ...p, id: crypto.randomUUID() }));
                await savePlayers(playersWithId);
                await saveTeams(gameData.teams);
                await saveStaff(gameData.staff.filter(s => s.teamId), staffPath());
                await saveStaff(gameData.staff.filter(s => !s.teamId), availableStaffPath());

                console.log("Game loaded from URL and saved to Firestore.");
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('gameContainer').classList.remove('hidden');
                renderUI();

            } catch (error) {
                console.error("Failed to load game from URL:", error);
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('startScreen').classList.remove('hidden');
                urlError.textContent = `Error: ${error.message}`;
                urlError.classList.remove('hidden');
            }
        };

        const showSetupScreen = () => {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');

            const leagueSelectionDiv = document.getElementById('leagueSelection');
            leagueSelectionDiv.innerHTML = '';
            for (const key in state.leagues) {
                if (key !== 'pro') continue;
                const league = state.leagues[key];
                const btn = document.createElement('button');
                btn.className = 'w-full text-left px-6 py-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors font-semibold league-btn';
                btn.textContent = `${league.name} (${league.teams} teams)`;
                btn.dataset.league = key;
                leagueSelectionDiv.appendChild(btn);
            }

            document.querySelectorAll('.league-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.league-btn').forEach(b => b.classList.remove('ring-2', 'ring-green-500'));
                    btn.classList.add('ring-2', 'ring-green-500');
                    document.getElementById('startGameBtn').dataset.league = btn.dataset.league;
                });
            });
        };

        const startNewGame = async (leagueKey) => {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            const league = state.leagues[leagueKey];
            const teams = generateTeams(league.teams, 'pro');
            const highSchoolPlayers = generatePlayers(state.leagues.highschool.teams * 25, [17, 18], 'highschool');
            const proPlayers = generatePlayers(league.teams * 25, [22, 35], 'pro');
            const allStaff = generateStaff(100);

            // Assign user's team
            teams[0].id = state.userTeamId;
            teams[0].name = 'Your Team';
            
            // Assign players to teams
            proPlayers.forEach(p => {
                const teamIndex = Math.floor(Math.random() * teams.length);
                p.teamId = teams[teamIndex].id;
            });
            
            // Assign staff to teams
            allStaff.forEach(s => {
                const teamIndex = Math.floor(Math.random() * teams.length);
                s.teamId = teams[teamIndex].id;
            });

            // Hire a starting staff for the user's team
            const userStaff = [
                allStaff.find(s => s.role === 'Head Coach' && s.teamId !== state.userTeamId),
                allStaff.find(s => s.role === 'Offensive Coordinator' && s.teamId !== state.userTeamId),
                allStaff.find(s => s.role === 'Defensive Coordinator' && s.teamId !== state.userTeamId),
            ].filter(Boolean);

            userStaff.forEach(s => s.teamId = state.userTeamId);
            
            const batch = writeBatch(db);
            teams.forEach(t => batch.set(doc(db, teamsPath(), t.id), t));
            proPlayers.concat(highSchoolPlayers).forEach(p => batch.set(doc(db, playersPath(), crypto.randomUUID()), p));
            allStaff.forEach(s => batch.set(doc(db, staffPath(), crypto.randomUUID()), s));

            await batch.commit();

            await saveGameState();
            console.log("New game started and data saved.");
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            renderUI();
        };

        const advanceWeek = async () => {
            if (state.weeksSimulated >= 16) {
                await simulateSeason();
                await enterOffseason();
            } else {
                const userTeam = state.teams.find(t => t.id === state.userTeamId);
                const opponent = state.teams.find(t => t.id !== userTeam.id && t.roster.length > 0);
                if (userTeam && opponent) {
                    simulateGame(userTeam.id, opponent.id);
                } else {
                    console.log("Not enough teams to simulate a game.");
                }
                state.weeksSimulated++;
            }
            await saveGameState();
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();
            await handleAuthentication();

            document.getElementById('newGameBtn').addEventListener('click', showSetupScreen);
            document.getElementById('loadGameBtn').addEventListener('click', loadGameState);
            document.getElementById('loadUrlBtn').addEventListener('click', loadFromUrl);
            document.getElementById('startGameBtn').addEventListener('click', (e) => {
                const league = e.currentTarget.dataset.league;
                if (league) {
                    startNewGame(league);
                } else {
                    alert('Please select a league to start the game.');
                }
            });

            document.querySelectorAll('[data-view]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    state.view = e.currentTarget.dataset.view;
                    renderUI();
                });
            });

            document.getElementById('simulateBtn').addEventListener('click', () => {
                if (state.gameState === 'offseason') {
                    simulateDraftPick();
                } else {
                    advanceWeek();
                }
            });
            document.getElementById('saveGameBtn').addEventListener('click', saveGameState);
            document.getElementById('closeModalBtn').addEventListener('click', () => {
                document.getElementById('playerModal').close();
            });
            document.getElementById('closeStaffModalBtn').addEventListener('click', () => {
                document.getElementById('staffModal').close();
            });
        });
    </script>
</body>
</html>
