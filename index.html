<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>American Football Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Tailwind gray-900 */
            color: #e2e8f0; /* Tailwind gray-200 */
        }
        .sidebar {
            width: 280px;
            background-color: #2d3748; /* Tailwind gray-800 */
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
        }
        .main-content {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .table-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .stat-bar {
            background-color: #4a5568; /* Tailwind gray-600 */
            height: 10px;
        }
        .stat-fill {
            background-color: #48bb78; /* Tailwind green-500 */
        }
        /* Style for scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        .text-neon-green {
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }
        .btn {
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition-property: transform;
            transition-duration: 150ms;
            transform: none;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>
<body class="flex min-h-screen">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 flex items-center justify-center bg-gray-900 z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-green-500"></div>
            <p class="mt-4 text-xl font-bold">Initializing Game...</p>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 z-40 hidden">
        <h1 class="text-6xl font-extrabold text-neon-green mb-10">AFM</h1>
        <div class="space-y-4">
            <button id="newGameBtn" class="btn bg-green-600 hover:bg-green-700 text-white w-64">New Game</button>
            <button id="loadGameBtn" class="btn bg-gray-700 hover:bg-gray-600 text-white w-64">Load Game</button>
            <div class="pt-4 border-t border-gray-700 w-64 space-y-2">
                <label for="urlInput" class="text-sm text-gray-400">Load from URL:</label>
                <input type="url" id="urlInput" placeholder="Enter .json URL" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 text-white placeholder-gray-500">
                <button id="loadUrlBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white w-full">Load from URL</button>
                <p id="urlError" class="text-sm text-red-400 hidden"></p>
            </div>
        </div>
    </div>

    <!-- Game Setup Screen -->
    <div id="setupScreen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 z-40 hidden">
        <h2 class="text-4xl font-extrabold text-neon-green mb-6">Game Setup</h2>
        <div class="bg-gray-800 rounded-lg p-8 shadow-xl max-w-xl w-full">
            <h3 class="text-xl font-bold mb-4">Choose Your League</h3>
            <div id="leagueSelection" class="space-y-4 mb-6">
                <!-- Leagues will be populated here -->
            </div>
            <button id="startGameBtn" class="btn bg-green-600 hover:bg-green-700 text-white w-full">Start Game</button>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer" class="flex flex-1 hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar flex flex-col p-4 shadow-lg z-10">
            <h1 class="text-3xl font-bold text-neon-green mb-6">AFM</h1>
            <nav class="space-y-4 flex-grow">
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="home">
                    Home
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="roster">
                    Roster
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="frontOffice">
                    Front Office
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="staffManagement">
                    Staff Management
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="standings">
                    Standings
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="schedule">
                    Schedule
                </button>
                <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" data-view="history">
                    Historical Standings
                </button>
                <button id="draftBtn" class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors hidden" data-view="draft">
                    Draft
                </button>
            </nav>
            <div class="mt-auto pt-4 border-t border-gray-600">
                <button id="saveGameBtn" class="w-full text-left px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 transition-colors">
                    Save Game
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="mainContent" class="main-content flex flex-col items-start gap-6 relative">
            <div id="gameStatus" class="bg-gray-800 rounded-lg p-4 flex items-center justify-between w-full shadow-md">
                <div class="flex-1">
                    <span id="currentYear" class="text-lg font-bold"></span>
                    <p id="userTeam" class="text-sm text-gray-400"></p>
                    <p id="teamBudget" class="text-sm text-gray-400 mt-1"></p>
                </div>
                <div class="flex gap-4">
                    <button onclick="advanceWeek()" 
                            class="btn bg-green-600 hover:bg-green-700">
                        Advance Week
                    </button>
                    <button onclick="simMultipleWeeks(4)" 
                            class="btn bg-blue-600 hover:bg-blue-700">
                        Sim Month
                    </button>
                    <div class="text-xl">
                        Week: ${state.weeksSimulated} | Year: ${state.currentYear}
                    </div>
                </div>
            </div>
            <div id="viewContainer" class="w-full">
                <!-- Dynamic content will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Player Modal -->
    <dialog id="playerModal" class="p-8 rounded-lg bg-gray-800 text-white shadow-xl max-w-2xl w-full z-20 modal-backdrop">
        <div class="flex justify-between items-start mb-4">
            <h3 id="modalTitle" class="text-2xl font-bold"></h3>
            <button id="closeModalBtn" class="text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="modalContent" class="space-y-4">
            <!-- Player details will be inserted here -->
        </div>
    </dialog>

    <!-- Staff Modal -->
    <dialog id="staffModal" class="p-8 rounded-lg bg-gray-800 text-white shadow-xl max-w-2xl w-full z-20 modal-backdrop">
        <div class="flex justify-between items-start mb-4">
            <h3 id="staffModalTitle" class="text-2xl font-bold"></h3>
            <button id="closeStaffModalBtn" class="text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="staffModalContent" class="space-y-4">
            <!-- Staff details will be inserted here -->
        </div>
    </dialog>


    <script type="module">
        import GameEngine from './src/GameEngine.js';

        // Initialize game engine
        const game = new GameEngine();

        // Initialize new game
        async function startNewGame(leagueType) {
            state = GameState.reset();
            const { teams, players } = LeagueInitializer.initializeLeague(leagueType);
            
            state.teams = teams;
            state.players = players;
            state.leagueType = leagueType;
            state.userTeamId = teams[0].id;
            state.gameState = 'playing';
            
            GameState.save(state);
            renderUI();
        }

        // Week simulation
        async function advanceWeek() {
            state = await GameLoop.advanceWeek(state);
            renderUI();
        }

        // Multiple week simulation
        async function simMultipleWeeks(weeks) {
            for (let i = 0; i < weeks; i++) {
                if (state.currentWeek >= 17) break;
                state = await GameLoop.advanceWeek(state);
            }
            renderUI();
        }

        // --- UI Rendering ---
        const renderUI = () => {
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = '';
            document.getElementById('currentYear').textContent = `Year: ${state.currentYear}`;
            document.getElementById('userTeam').textContent = `Team: ${state.teams.find(t => t.id === state.userTeamId)?.name || 'Unknown'}`;
            document.getElementById('teamBudget').textContent = `Budget: $${state.teamBudget.toLocaleString('en-US')}`;

            const simulateBtn = document.getElementById('simulateBtn');
            const draftBtn = document.getElementById('draftBtn');
            draftBtn.classList.add('hidden');

            if (state.gameState === 'offseason') {
                simulateBtn.textContent = 'Simulate Draft Pick';
                simulateBtn.disabled = false;
                draftBtn.classList.remove('hidden');
            } else {
                simulateBtn.textContent = state.weeksSimulated < 16 ? `Simulate Week ${state.weeksSimulated + 1}` : 'End Season & Enter Offseason';
                simulateBtn.disabled = false;
            }
            
            switch (state.view) {
                case 'home': renderHome(); break;
                case 'roster': renderRoster(); break;
                case 'frontOffice': renderFrontOffice(); break;
                case 'staffManagement': renderStaffManagement(); break;
                case 'standings': renderStandings(); break;
                case 'schedule': renderSchedule(); break;
                case 'history': renderHistoricalStandings(); break;
                case 'draft':
                    if (state.gameState === 'offseason') {
                        renderDraft();
                    } else {
                        renderDraftPlaceholder();
                    }
                    break;
            }
        };

        const renderHome = () => {
            const container = document.getElementById('viewContainer');
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Welcome to American Football Manager</h2>
                    <p class="text-gray-400">Manage your team from the ground up, scouting players from high school and college to build a dynasty in the pro league. Simulate seasons and guide your team to victory!</p>
                </div>
            `;
        };

        const renderRoster = () => {
            const container = document.getElementById('viewContainer');
            const userRoster = state.players.filter(p => p.teamId === state.userTeamId);

            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Team Roster</h2>
                    <div class="table-container">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-700">
                                    <th class="p-4 rounded-tl-lg">Name</th>
                                    <th class="p-4">POS</th>
                                    <th class="p-4">Age</th>
                                    <th class="p-4">OVR</th>
                                    <th class="p-4">Potential</th>
                                    <th class="p-4 rounded-tr-lg">Salary</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userRoster.map(p => `
                                    <tr class="border-t border-gray-700 hover:bg-gray-700 cursor-pointer player-row" data-id="${p.id}">
                                        <td class="p-4">${p.name}</td>
                                        <td class="p-4">${p.position}</td>
                                        <td class="p-4">${p.age}</td>
                                        <td class="p-4">${p.getOverallRating()}</td>
                                        <td class="p-4">${p.potential}</td>
                                        <td class="p-4">$${p.salary.toLocaleString('en-US')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            container.querySelectorAll('.player-row').forEach(row => {
                row.addEventListener('click', (e) => showPlayerModal(e.currentTarget.dataset.id));
            });
        };
        
        const renderFrontOffice = () => {
            const container = document.getElementById('viewContainer');
            const userStaff = state.staff.filter(s => s.teamId === state.userTeamId);
            const headCoach = userStaff.find(s => s.role === 'Head Coach');
            const offensiveCoordinator = userStaff.find(s => s.role === 'Offensive Coordinator');
            const defensiveCoordinator = userStaff.find(s => s.role === 'Defensive Coordinator');
            const positionalCoaches = userStaff.filter(s => s.role.includes('Coach') && s.role !== 'Head Coach');

            const renderStaffCard = (staff) => {
                if (!staff) return '<div class="bg-gray-700 rounded-lg p-4 shadow-md text-center text-gray-400">No staff hired</div>';
                let skillsHtml = Object.entries(staff.skills).map(([skill, value]) => `
                    <div class="flex items-center space-x-2">
                        <span class="capitalize text-sm font-semibold">${skill}:</span>
                        <div class="bg-gray-600 rounded-full h-2 flex-1">
                            <div class="bg-green-500 rounded-full h-2" style="width: ${value}%"></div>
                        </div>
                        <span class="text-xs text-gray-400">${value}</span>
                    </div>
                `).join('');

                return `
                    <div class="bg-gray-700 rounded-lg p-4 shadow-md">
                        <h3 class="font-bold text-lg">${staff.name}</h3>
                        <p class="text-gray-400 text-sm mb-2">${staff.role}</p>
                        <p class="text-gray-300 text-sm mb-2">Salary: $${staff.salary.toLocaleString('en-US')}</p>
                        <div class="space-y-1 mt-2">
                            ${skillsHtml}
                        </div>
                    </div>
                `;
            };

            const positionalCoachesHtml = positionalCoaches.map(coach => renderStaffCard(coach)).join('');

            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Front Office</h2>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-xl font-bold mb-2">Head Coach</h3>
                            ${renderStaffCard(headCoach)}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">Coordinators</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${renderStaffCard(offensiveCoordinator)}
                                ${renderStaffCard(defensiveCoordinator)}
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">Positional Coaches</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${positionalCoachesHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderStaffManagement = () => {
            const container = document.getElementById('viewContainer');
            const userStaff = state.staff.filter(s => s.teamId === state.userTeamId);
            const availableStaff = state.availableStaff;
        
            const renderStaffTable = (staffList, actionBtnText, actionFn) => {
                return `
                    <div class="table-container bg-gray-700 rounded-lg p-4 shadow-md">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-600">
                                    <th class="p-4 rounded-tl-lg">Name</th>
                                    <th class="p-4">Role</th>
                                    <th class="p-4">Salary</th>
                                    <th class="p-4 rounded-tr-lg">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${staffList.map(s => `
                                    <tr class="border-t border-gray-500 hover:bg-gray-600 cursor-pointer staff-row" data-id="${s.id}">
                                        <td class="p-4">${s.name}</td>
                                        <td class="p-4">${s.role}</td>
                                        <td class="p-4">$${s.salary.toLocaleString('en-US')}</td>
                                        <td class="p-4">
                                            <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-lg text-xs staff-action-btn" data-id="${s.id}" data-action="${actionFn}">${actionBtnText}</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };
        
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Staff Management</h2>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-2">Your Staff</h3>
                        ${renderStaffTable(userStaff, 'Fire', 'fire')}
                    </div>
        
                    <div>
                        <h3 class="text-xl font-bold mb-2">Available Staff</h3>
                        ${renderStaffTable(availableStaff, 'Hire', 'hire')}
                    </div>
                </div>
            `;

            container.querySelectorAll('.staff-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('staff-action-btn')) {
                        showStaffModal(e.currentTarget.dataset.id);
                    }
                });
            });

            container.querySelectorAll('.staff-action-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const staffId = e.target.dataset.id;
                    const action = e.target.dataset.action;
                    if (action === 'hire') {
                        await hireStaff(staffId);
                    } else if (action === 'fire') {
                        await fireStaff(staffId);
                    }
                });
            });
        };
        
        const hireStaff = async (staffId) => {
            const staff = state.availableStaff.find(s => s.id === staffId);
            if (!staff) return;
        
            if (state.teamBudget < staff.salary) {
                alert("Not enough budget to hire this staff member!");
                return;
            }
        
            const currentStaff = state.staff.filter(s => s.teamId === state.userTeamId);
            if (staff.role === 'Head Coach' && currentStaff.find(s => s.role === 'Head Coach')) {
                alert('You already have a Head Coach.');
                return;
            }
            if (staff.role === 'Offensive Coordinator' && currentStaff.find(s => s.role === 'Offensive Coordinator')) {
                alert('You already have an Offensive Coordinator.');
                return;
            }
            if (staff.role === 'Defensive Coordinator' && currentStaff.find(s => s.role === 'Defensive Coordinator')) {
                alert('You already have a Defensive Coordinator.');
                return;
            }
            if (staff.role.includes('Coach') && currentStaff.filter(s => s.role === staff.role).length >= 1) {
                alert(`You already have a ${staff.role}.`);
                return;
            }
            
            await updateDoc(doc(db, availableStaffPath(), staff.id), { teamId: state.userTeamId });
            state.teamBudget -= staff.salary;
            await saveGameState();
            renderUI();
        };

        const fireStaff = async (staffId) => {
            const staff = state.staff.find(s => s.id === staffId);
            if (!staff) return;

            await updateDoc(doc(db, staffPath(), staff.id), { teamId: null });
            state.teamBudget += staff.salary / 2;
        
            await saveGameState();
            renderUI();
        };

        const renderStandings = () => {
            const container = document.getElementById('viewContainer');
            const standings = [...state.teams].sort((a, b) => (b.wins - b.losses) - (a.wins - a.losses));

            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Current Standings</h2>
                    <div class="table-container">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-700">
                                    <th class="p-4 rounded-tl-lg">Team</th>
                                    <th class="p-4">Wins</th>
                                    <th class="p-4">Losses</th>
                                    <th class="p-4 rounded-tr-lg">Ties</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${standings.map(t => `
                                    <tr class="border-t border-gray-700">
                                        <td class="p-4">${t.name}</td>
                                        <td class="p-4">${t.wins}</td>
                                        <td class="p-4">${t.losses}</td>
                                        <td class="p-4">${t.ties}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const renderHistoricalStandings = () => {
            const container = document.getElementById('viewContainer');
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Historical Standings</h2>
                    ${state.historicalSeasons.map(season => `
                        <div class="bg-gray-700 rounded-lg p-4 mb-4 shadow-md">
                            <h3 class="text-xl font-bold mb-2">Year: ${season.year}</h3>
                            <div class="table-container">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-gray-600">
                                            <th class="p-2">Team</th>
                                            <th class="p-2">Wins</th>
                                            <th class="p-2">Losses</th>
                                            <th class="p-2">Ties</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${season.standings.map(t => `
                                            <tr class="border-t border-gray-500">
                                                <td class="p-2">${t.name}</td>
                                                <td class="p-2">${t.wins}</td>
                                                <td class="p-2">${t.losses}</td>
                                                <td class="p-2">${t.ties}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        };

        const renderSchedule = () => {
            const container = document.getElementById('viewContainer');
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Season Schedule</h2>
                    <p class="text-gray-400">The schedule is currently being generated...</p>
                </div>
            `;
        };

        const renderDraft = () => {
            const container = document.getElementById('viewContainer');
            const userTeam = state.teams.find(t => t.id === state.userTeamId);
            
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Pro Draft</h2>
                    <p class="text-gray-400 mb-2">Round: ${state.draftRound} | Pick: ${state.draftPick}</p>
                    <p class="text-gray-400 mb-4">Select a player from the draft pool to add to your team.</p>
                    <div class="table-container">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-700">
                                    <th class="p-4 rounded-tl-lg">Name</th>
                                    <th class="p-4">POS</th>
                                    <th class="p-4">Age</th>
                                    <th class="p-4">OVR</th>
                                    <th class="p-4">Potential</th>
                                    <th class="p-4 rounded-tr-lg">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.draftPool.map(p => `
                                    <tr class="border-t border-gray-700 hover:bg-gray-700 cursor-pointer player-row" data-id="${p.id}">
                                        <td class="p-4">${p.name}</td>
                                        <td class="p-4">${p.position}</td>
                                        <td class="p-4">${p.age}</td>
                                        <td class="p-4">${p.getOverallRating()}</td>
                                        <td class="p-4">${p.potential}</td>
                                        <td class="p-4">
                                            <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm draft-btn" data-id="${p.id}">Draft</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            container.querySelectorAll('.player-row').forEach(row => {
                row.addEventListener('click', (e) => showPlayerModal(e.currentTarget.dataset.id));
            });
            container.querySelectorAll('.draft-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const playerId = e.currentTarget.dataset.id;
                    await draftPlayer(playerId);
                });
            });
            document.getElementById('simulateBtn').disabled = false;
        };
        
        const renderDraftPlaceholder = () => {
             const container = document.getElementById('viewContainer');
             container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 shadow-md w-full">
                    <h2 class="text-2xl font-bold mb-4">Pro Draft Pool</h2>
                    <p class="text-gray-400">The draft pool will be populated by college players who have declared after their senior year. Please enter the offseason to view the draft pool.</p>
                </div>
            `;
        }


        const showPlayerModal = (playerId) => {
            const player = [...state.players, ...state.collegePlayers, ...state.highSchoolPlayers, ...state.draftPool].find(p => p.id === playerId);
            if (!player) return;

            const modal = document.getElementById('playerModal');
            document.getElementById('modalTitle').textContent = `${player.name} (${player.position})`;
            const modalContent = document.getElementById('modalContent');
            
            let attributesHtml = '';
            for (const category in player.attributes) {
                attributesHtml += `<h4 class="font-bold text-lg capitalize">${category.replace('_', ' ')} Attributes</h4>`;
                attributesHtml += `<div class="space-y-2 mt-2 mb-4">`;
                for (const attr in player.attributes[category]) {
                    const value = player.attributes[category][attr];
                    attributesHtml += `
                        <div>
                            <span class="capitalize">${attr.replace('_', ' ')}:</span>
                            <div class="bg-gray-600 rounded-full h-2.5">
                                <div class="bg-green-500 rounded-full h-2.5" style="width: ${value}%"></div>
                            </div>
                        </div>
                    `;
                }
                attributesHtml += `</div>`;
            }

            modalContent.innerHTML = `
                <p><strong>Age:</strong> ${player.age}</p>
                <p><strong>Overall:</strong> ${player.getOverallRating()}</p>
                <p><strong>League:</strong> ${player.league}</p>
                <p><strong>Team:</strong> ${state.teams.find(t => t.id === player.teamId)?.name || 'N/A'}</p>
                <p><strong>Salary:</strong> $${player.salary.toLocaleString('en-US')}</p>
                <div class="mt-4">
                    ${attributesHtml}
                </div>
            `;
            modal.showModal();
        };

        const showStaffModal = (staffId) => {
            const staff = [...state.staff, ...state.availableStaff].find(s => s.id === staffId);
            if (!staff) return;

            const modal = document.getElementById('staffModal');
            document.getElementById('staffModalTitle').textContent = `${staff.name} (${staff.role})`;
            const modalContent = document.getElementById('staffModalContent');

            let skillsHtml = '';
            for (const skill in staff.skills) {
                const value = staff.skills[skill];
                skillsHtml += `
                    <div>
                        <span class="capitalize">${skill}:</span>
                        <div class="bg-gray-600 rounded-full h-2.5">
                            <div class="bg-green-500 rounded-full h-2.5" style="width: ${value}%"></div>
                        </div>
                    </div>
                `;
            }

            modalContent.innerHTML = `
                <p><strong>Role:</strong> ${staff.role}</p>
                <p><strong>Salary:</strong> $${staff.salary.toLocaleString('en-US')}</p>
                <div class="space-y-2 mt-4">
                    <h4 class="font-bold text-lg">Skills</h4>
                    ${skillsHtml}
                </div>
            `;
            modal.showModal();
        };

        // --- Firebase Data Operations ---
        const gameDataPath = () => `artifacts/${appId}/users/${userId}/gameData/state`;
        const teamsPath = () => `artifacts/${appId}/users/${userId}/teams`;
        const playersPath = () => `artifacts/${appId}/users/${userId}/players`;
        const staffPath = () => `artifacts/${appId}/users/${userId}/staff`;
        const availableStaffPath = () => `artifacts/${appId}/users/${userId}/availableStaff`;
        const draftPoolPath = () => `artifacts/${appId}/users/${userId}/draftPool`;
        const historyPath = () => `artifacts/${appId}/users/${userId}/historicalSeasons`;
        
        // --- Local Storage Data Operations ---
        const saveGameState = async () => {
            try {
                localStorage.setItem('gameState', JSON.stringify(state));
                console.log("Game state saved locally.");
            } catch (error) {
                console.error("Error saving game state:", error);
            }
        };

        const loadGameState = async () => {
            try {
                const savedState = localStorage.getItem('gameState');
                if (savedState) {
                    Object.assign(state, JSON.parse(savedState));
                    console.log("Game state loaded from local storage.");
                    renderUI();
                } else {
                    console.warn("No saved game state found.");
                }
            } catch (error) {
                console.error("Failed to load game state:", error);
            }
        };

        // Repeat similar for teams, players, staff, etc.
        const saveTeams = async () => {
            localStorage.setItem('teams', JSON.stringify(state.teams));
        };
        const loadTeams = async () => {
            const teams = localStorage.getItem('teams');
            if (teams) state.teams = JSON.parse(teams);
        };

        const savePlayers = async (playersToSave) => {
            if (!db || !userId) return;
            const batch = writeBatch(db);
            playersToSave.forEach(p => {
                const playerRef = doc(db, playersPath(), p.id);
                batch.set(playerRef, p);
            });
            await batch.commit();
        };

        const saveStaff = async (staffToSave, collectionPath) => {
            if (!db || !userId) return;
            const batch = writeBatch(db);
            staffToSave.forEach(s => {
                const staffRef = doc(db, collectionPath, s.id);
                batch.set(staffRef, s);
            });
            await batch.commit();
        };

        const saveDraftPool = async () => {
            if (!db || !userId) return;
            const batch = writeBatch(db);
            const docs = await getDocs(collection(db, draftPoolPath()));
            docs.forEach(d => batch.delete(d.ref));
            state.draftPool.forEach(p => {
                const playerRef = doc(db, draftPoolPath(), p.id);
                batch.set(playerRef, p);
            });
            await batch.commit();
        };

        const loadFromUrl = async () => {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            const urlError = document.getElementById('urlError');

            if (!url) {
                urlError.textContent = "Please enter a valid URL.";
                urlError.classList.remove('hidden');
                return;
            } else {
                urlError.classList.add('hidden');
            }

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const gameData = await response.json();

                if (!gameData.state || !gameData.players || !gameData.teams || !gameData.staff) {
                    throw new Error("Invalid game data format. Missing required fields.");
                }
                
                Object.assign(state, gameData.state);
                await saveGameState();

                const playersWithId = gameData.players.map(p => ({ ...p, id: crypto.randomUUID() }));
                await savePlayers(playersWithId);
                await saveTeams(gameData.teams);
                await saveStaff(gameData.staff.filter(s => s.teamId), staffPath());
                await saveStaff(gameData.staff.filter(s => !s.teamId), availableStaffPath());

                console.log("Game loaded from URL and saved to Firestore.");
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('gameContainer').classList.remove('hidden');
                renderUI();

            } catch (error) {
                console.error("Failed to load game from URL:", error);
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('startScreen').classList.remove('hidden');
                urlError.textContent = `Error: ${error.message}`;
                urlError.classList.remove('hidden');
            }
        };

        const showSetupScreen = () => {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');

            const leagueSelectionDiv = document.getElementById('leagueSelection');
            leagueSelectionDiv.innerHTML = '';
            for (const key in state.leagues) {
                if (key !== 'pro') continue;
                const league = state.leagues[key];
                const btn = document.createElement('button');
                btn.className = 'w-full text-left px-6 py-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors font-semibold league-btn';
                btn.textContent = `${league.name} (${league.teams} teams)`;
                btn.dataset.league = key;
                leagueSelectionDiv.appendChild(btn);
            }

            document.querySelectorAll('.league-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.league-btn').forEach(b => b.classList.remove('ring-2', 'ring-green-500'));
                    btn.classList.add('ring-2', 'ring-green-500');
                    document.getElementById('startGameBtn').dataset.league = btn.dataset.league;
                });
            });
        };

        const startNewGame = async (leagueKey) => {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            const league = state.leagues[leagueKey];
            const teams = generateTeams(league.teams, 'pro');
            const highSchoolPlayers = generatePlayers(state.leagues.highschool.teams * 25, [17, 18], 'highschool');
            const proPlayers = generatePlayers(league.teams * 25, [22, 35], 'pro');
            const allStaff = generateStaff(100);

            // Assign user's team
            teams[0].id = state.userTeamId;
            teams[0].name = 'Your Team';
            
            // Assign players to teams
            proPlayers.forEach(p => {
                const teamIndex = Math.floor(Math.random() * teams.length);
                p.teamId = teams[teamIndex].id;
            });
            
            // Assign staff to teams
            allStaff.forEach(s => {
                const teamIndex = Math.floor(Math.random() * teams.length);
                s.teamId = teams[teamIndex].id;
            });

            // Hire a starting staff for the user's team
            const userStaff = [
                allStaff.find(s => s.role === 'Head Coach' && s.teamId !== state.userTeamId),
                allStaff.find(s => s.role === 'Offensive Coordinator' && s.teamId !== state.userTeamId),
                allStaff.find(s => s.role === 'Defensive Coordinator' && s.teamId !== state.userTeamId),
            ].filter(Boolean);

            userStaff.forEach(s => s.teamId = state.userTeamId);
            
            const batch = writeBatch(db);
            teams.forEach(t => batch.set(doc(db, teamsPath(), t.id), t));
            proPlayers.concat(highSchoolPlayers).forEach(p => batch.set(doc(db, playersPath(), crypto.randomUUID()), p));
            allStaff.forEach(s => batch.set(doc(db, staffPath(), crypto.randomUUID()), s));

            await batch.commit();

            await saveGameState();
            console.log("New game started and data saved.");
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            renderUI();
        };

        async function initializeGame(leagueType) {
            state.leagueType = leagueType;
            const gameData = GameInitializer.initializeLeague(leagueType);
            
            Object.assign(state, gameData);
            LocalStorage.save('gameState', state);
            
            renderUI();
        }

        async function advanceWeek() {
            state.weeksSimulated++;
            
            // Simulate games for current week
            const weekGames = state.schedule.filter(game => game.week === state.weeksSimulated);
            weekGames.forEach(game => simulateGame(game.homeTeam, game.awayTeam));
            
            if (state.weeksSimulated >= 17) { // End of regular season
                await enterOffseason();
            }
            
            LocalStorage.save('gameState', state);
            renderUI();
        }

        async function simMultipleWeeks(numWeeks) {
            for (let i = 0; i < numWeeks; i++) {
                if (state.weeksSimulated >= 17) break;
                await advanceWeek();
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();
            await handleAuthentication();

            document.getElementById('newGameBtn').addEventListener('click', showSetupScreen);
            document.getElementById('loadGameBtn').addEventListener('click', loadGameState);
            document.getElementById('loadUrlBtn').addEventListener('click', loadFromUrl);
            document.getElementById('startGameBtn').addEventListener('click', (e) => {
                const league = e.currentTarget.dataset.league;
                if (league) {
                    startNewGame(league);
                } else {
                    alert('Please select a league to start the game.');
                }
            });

            document.querySelectorAll('[data-view]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    state.view = e.currentTarget.dataset.view;
                    renderUI();
                });
            });

            document.getElementById('simulateBtn').addEventListener('click', () => {
                if (state.gameState === 'offseason') {
                    simulateDraftPick();
                } else {
                    advanceWeek();
                }
            });
            document.getElementById('saveGameBtn').addEventListener('click', saveGameState);
            document.getElementById('closeModalBtn').addEventListener('click', () => {
                document.getElementById('playerModal').close();
            });
            document.getElementById('closeStaffModalBtn').addEventListener('click', () => {
                document.getElementById('staffModal').close();
            });
        });
    </script>
</body>
</html>
